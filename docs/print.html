<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fern</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Fern</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="what-is-fern"><a class="header" href="#what-is-fern">What is Fern?</a></h1>
<p>Fern optimizes pipelines built from sequences of function calls. In particular,
Fern <a href="fusion.html"><em>fuses</em></a> function calls, and produces code that evaluates
operations back-to-back on small chunks of data as opposed to entire outputs.
Fern accomplishes this by requiring functions to declare how they produce and
consume data.</p>
<p>Fern's core idea is that that fused code naturally separates concerns: inner
loops handle computation and hardware-specific logic, while outer loops manage
data movement. Fern uses black-box subroutines to perform computations and uses
simple dataflow analysis to generate outer loops.</p>
<p>Our <a href="https://dl.acm.org/doi/10.1145/3729292">paper</a> on <em>Lightweight and
Locality-Aware Composition of Black-Box Subroutines</em> discusses Fern's design
philosophy in detail.</p>
<h3 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h3>
<p>To get started with Fern, take a look at the <a href="install.html">installation</a>
instructions.</p>
<p>The <a href="tutorial/overview.html">tutorial</a> walks through several example Fern programs
to help you understand how it works in practice.</p>
<h3 id="talk"><a class="header" href="#talk">Talk</a></h3>
<p>You can also watch our CppCon talk about Fern. Fern has evolved quite
a bit since then, but the design philosophy at its core has remained
the same.</p>
<div style="text-align: center;">
    <iframe width="560" height="315" src="https://www.youtube.com/embed/pEcOZDRXhNM?si=8q2EeHAD2LNppECr" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="an-introduction-to-operator-fusion"><a class="header" href="#an-introduction-to-operator-fusion">An Introduction to Operator Fusion</a></h1>
<h2 id="a-simple-example"><a class="header" href="#a-simple-example">A Simple Example</a></h2>
<p>Consider a simple function that takes in an array of floats <code>$a$</code>,
and adds 1 to each element, storing its output in <code>$b$</code>:</p>
<pre><code class="language-C++">void add_1(float * a, float *b, int N){
    for (int i = 0; i &lt; N; i++){
        b[i] = a[i] + 1;
    }
}
</code></pre>
<p>To perform 2 to elements to an array, we can simply call <code>add_1</code> twice:</p>
<pre><code class="language-C++">    float * a  = (float *) malloc(N * sizeof(float)) 
    float * b  = (float *) malloc(N * sizeof(float)) 
    float * c  = (float *) malloc(N * sizeof(float)) 
    add_1(b, a, N);
    add_1(c, b, N);
</code></pre>
<p>or, we can implement a special  <code>add_2</code> function:</p>
<pre><code class="language-C++">void add_2(float * a, float *b, int N){
    for (int i = 0; i &lt; N; i++){
        b[i] = a[i] + 2;
    }
}
</code></pre>
<p>and simply call it:</p>
<pre><code class="language-C++">    float * a  = (float *) malloc(N * sizeof(float)) 
    float * c  = (float *) malloc(N * sizeof(float)) 
    add_2(c, a, N);
</code></pre>
<p>The <code>add_2</code> function not only uses less memory, requiring no allocation for an
intermediate, it also takes advantage of <em>locality</em>. Each float is loaded once
and all operations are applied immediately, when the data is ready. This
technique of applying a sequence of operations back-to-back on susbets of data
rather than computing entire intermediate outputs is called <strong>operator fusion</strong>.</p>
<p>Traditionally, your favorite compiler runs a fusion pass, bringing computations
into the same outer-loop scope when it can determine that the transformation is
correct. While these passes typically fuse at single data element granularity,
one can also generalize this idea to instead think about fusion happening at
different granularities (4 elements, 8 elements, tiles of data, etc.).</p>
<h2 id="operator-fusion-in-practice"><a class="header" href="#operator-fusion-in-practice">Operator Fusion in Practice</a></h2>
<p>High-performance applications are often built as compositions of function calls,
many sourced from mature, highly optimized libraries like CBLAS.  On Appleâ€™s M3
chip, the fastest implementations of the CBLAS interface can be found in
frameworks such as Accelerate and Arm Performance Libraries.</p>
<blockquote>
<p>CBLAS itself contains several fused interfaces. For example, cblas_sgemm
performs a matrix-matrix multiplication with optional transposition and
scaling, all in a single call.</p>
</blockquote>
<p>Say we want to compute a General Vector Rank Update (GER)
operation expressed as \( A = \alpha (x \times y^T) + A \) where \( A \) is
a matrix, \( x \) and  \( y \) are vectors, \( \alpha \) is a scalar, and
all datatypes are floats. Both Accelerate and ArmPL offer implementations of
this operation, and their performance is pretty close.</p>
<div style="text-align: center;">
  <img src="./images/sger.png" alt="Diagram from PDF" style="width: 300px;" />
</div>
<p>If we were to comupute a slight variant of our computation, an SGERB \( A = \alpha (x
\times y^T) + \beta A \), we have two options. First,
we can use ArmPLâ€™s fused BLAS extension interfaces that include an <code>sgerb_</code> subroutine. Or, as
Accelerate has no fused subroutine, we can compose Accelerateâ€™s <code>cblas_sger</code> and <code>cblas_saxpy</code>
subroutines.</p>
<div style="text-align: center;">
  <img src="./images/sgerb.png" alt="Diagram from PDF" style="width: 300px;" />
</div>
<p>However, the fused ArmPL subroutine is 1.24Ã— (geomean) faster than the composed
Accelerate implementation. Since Accelerate already matched ArmPLâ€™s performance
on GER, the performance difference between the two implementations on GERB is
not due to an under-optimized inner loop or poor instruction selection, but is
rather introduced at the point of composition. ArmPL is able to <em>fuse</em> its
computation, resulting in the difference that we see.</p>
<p>In our trivial example with <code>add_1</code>, we could quickly write a fused
implementation. However, in this case, we are stuck: each routine <code>cblas_sger</code>
and <code>cblas_saxpy</code> likely contains hundereds of lines of hairy,
architecture-specific code that would be time consuming to rewrite and error prone
to modify. Worse, both ArmPL and Accelerate are propriety frameworks. In fact, the
Accelerate library is the only way to target undocumented, Apple-specific
hardware. If our user wants to use this special hardware, they are tied to the
Accelerate library, which does not have extended BLAS kernels like
<code>sgerb_</code>. But, if our user wants to use fused implementations provided in
the BLAS extension interface, they must use ArmPL.</p>
<p>Instead of using naive subroutine calls for Accelerate, the user can use code
generated by Fern, which continues to call Accelerate subroutines, but does so
for small tiles of the output at a time. To see how to do this, head to the
<a href="./tutorial/overview.html">tutorial</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<blockquote>
<p>Fern is now supported by the Gern repository. Gern adds support for GPUs and
contains Fern-style CPU support. Gern is under ðŸš§ active development ðŸš§.</p>
</blockquote>
<p>Fern is an open-source project available at
<a href="https://github.com/manya-bansal/gern">https://github.com/manya-bansal/gern</a>.</p>
<p>It is written in C++20 and requires CMake version 3.30 or higher to build.</p>
<h2 id="getting-the-repository"><a class="header" href="#getting-the-repository">Getting the Repository</a></h2>
<p>First, clone the repository from github.</p>
<pre><code class="language-bash">$ git clone git@github.com:manya-bansal/gern.git
</code></pre>
<h2 id="installing-dependencies"><a class="header" href="#installing-dependencies">Installing Dependencies</a></h2>
<h3 id="vcpkg"><a class="header" href="#vcpkg">VCPKG</a></h3>
<p>Fern uses <a href="https://github.com/microsoft/vcpkg"><code>vcpkg</code></a> to manage its
dependencies. Follow the official guide to download and install <code>vcpkg</code>: <a href="https://learn.microsoft.com/en-us/vcpkg/get_started/get-started?pivots=shell-powershell#1---set-up-vcpkg">Get Started with
vcpkg</a></p>
<p>Once installed, set the <code>VCPKG_ROOT</code> environment variable to point to your
<code>vcpkg</code> directory.</p>
<h3 id="cmake"><a class="header" href="#cmake">CMake</a></h3>
<p>Fern uses <code>cmake</code> as its build system. Before building Fern, ensure that <code>cmake</code>
is installed on your system. Fern requires cmake 3.30 and above.</p>
<p>You can download the latest version of CMake from the official website: <a href="https://cmake.org/download/">CMake
Downloads</a></p>
<h2 id="building-fern"><a class="header" href="#building-fern">Building Fern</a></h2>
<p>Now that <code>VCPKG_ROOT</code> is set and you have downloaded the repository, build the
repository from the <code>gern</code> directory:</p>
<pre><code class="language-bash">$ cmake -DGern_CUDA_ARCH=&lt;89,90..,etc&gt; --preset dev 
$ cmake --build build/dev
</code></pre>
<p>If <code>-DGern_CUDA_ARCH</code> is not set, none of the GPU kernels will be run during
tests.</p>
<h2 id="running-tests"><a class="header" href="#running-tests">Running Tests</a></h2>
<p>To run tests, execute:</p>
<pre><code class="language-bash">$ ctest --test-dir build/dev
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Coming Soon!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
